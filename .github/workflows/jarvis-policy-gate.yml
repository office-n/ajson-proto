name: Jarvis Policy Gate

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read
  pull-requests: write
  checks: read
  statuses: read

jobs:
  policy:
    runs-on: ubuntu-latest
    outputs:
      eligible: ${{ steps.eval.outputs.eligible }}
      reason:   ${{ steps.eval.outputs.reason }}
    steps:
      - name: Evaluate risk and eligibility
        id: eval
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // === 早期中断（キルスイッチ） ===
            if (process.env.JARVIS_AUTOMERGE === 'off') {
              core.setOutput('eligible','false');
              core.setOutput('reason','global kill switch');
              return;
            }
            if ((pr.labels || []).some(l => l.name === 'no-automerge')) {
              core.setOutput('eligible','false');
              core.setOutput('reason','label:no-automerge');
              return;
            }

            // === Jarvis 作成 PR だけ対象 ===
            const allowedAuthors = ['jarvis-bot','office-n']; // 必要に応じて調整
            if (!allowedAuthors.includes(pr.user.login)) {
              core.setOutput('eligible','false');
              core.setOutput('reason',`author ${pr.user.login} not allowed`);
              return;
            }

            // === 変更ファイルの取得 ===
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number: pr.number, per_page: 100 }
            );

            // === Blocklist（人間必須） ===
            const block = [
              /^\.github\//,
              /^cloudbuild.*\.ya?ml$/i,
              /^infra\//, /^terraform\//, /^setup_triggers\.sh$/,
              /^CODEOWNERS$/, /^\.?env/i
            ];
            const blocked = files.some(f => block.some(rx => rx.test(f.filename)));
            if (blocked) {
              core.setOutput('eligible','false');
              core.setOutput('reason','blocked-path changed');
              return;
            }

            // === Allowlist（この範囲内のみ自動可） ===
            const allow = [/^app\//, /^src\//, /^routes\//, /^server\.(py|js)$/, /^Dockerfile$/];
            const allAllowed = files.every(f => allow.some(rx => rx.test(f.filename)));
            if (!allAllowed) {
              core.setOutput('eligible','false');
              core.setOutput('reason','files outside allowlist');
              return;
            }

            // === 規模ガード ===
            const totalChanges = files.reduce((s,f) => s + (f.changes || 0), 0);
            const maxFiles = 20, maxChanges = 800;
            if (files.length > maxFiles || totalChanges > maxChanges) {
              core.setOutput('eligible','false');
              core.setOutput('reason','diff too large');
              return;
            }

            core.setOutput('eligible','true');
            core.setOutput('reason','ok');

      - name: Comment decision
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const eligible = '${{ steps.eval.outputs.eligible }}';
            const reason   = '${{ steps.eval.outputs.reason }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number,
              body: `Jarvis Policy Gate: **${eligible==='true' ? 'ELIGIBLE ✅' : 'NOT ELIGIBLE ⛔️'}** (${reason}).`
            });

  approve-and-automerge:
    needs: policy
    if: needs.policy.outputs.eligible == 'true'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      # GitHub App 経由のトークン（レビューが保護要件としてカウントされる）
      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.JARVIS_APP_ID }}
          private-key: ${{ secrets.JARVIS_APP_PRIVATE_KEY }}

      - name: Approve PR
        uses: peter-evans/approve-pull-request@v3
        with:
          token: ${{ steps.app-token.outputs.token }}
          pull-request-number: ${{ github.event.pull_request.number }}
          review-message: "Auto-approved by Jarvis Policy Gate."

      # Auto-merge は必須チェックが Green になった時点で GitHub 側が実施
      - name: Enable Auto-merge (squash)
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ steps.app-token.outputs.token }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
