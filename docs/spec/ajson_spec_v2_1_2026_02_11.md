# AJSON 設計仕様書 (v2.1)
Version: 2.1 (SSOT Fixed)
Date: 2026-02-11
Status: Proposed (Consolidated from v0.2 + SSOT v2.0)

## 0. 結論
本仕様書は、AJSON (Agent-driven JSON Orchestrator) のバージョン2.1における設計仕様を定義する。
従来の開発版 (v0.2) に、SSOT v2.0 (Remote Bridge/UX/Allowlist/Ants除外) の要件を正式統合し、
「UI生産性 (Cockpit)」と「統制 (Governance)」を両立する次世代SSOTとして固定する。

---

## 1. プロダクト定義 (v2.1)
- **Concept**: スマホから自宅PCを物理操作できる自律型OS（オーケストレーション基盤）。
- **AI Structure**:
  - **Main**: ChatGPT API (Planning/Reasoning)
  - **Sub**: Gemini API (Validation/Support)
- **Non-Goal**:
  - **Google Antigravity (Ants) 連携**: 依存せず、Ants相当機能（Orchestrator/Runner）を自前で実装する。
  - **既存AIアプリUI操作 (RPA)**: 信頼性欠如のため非推奨（API連携を主とする）。

---

## 2. 機能要件 (Cockpit UI)
- **Design Philosophy**: AGI Cockpit級の生産性と操作性を目指す。
- **UI Standard**: ChatGPT公式アプリ相当のUX基準。
- **Core Features**:
  - **Multi-line Input**: 複雑な指示を受け付けるエディタ。
  - **Voice IO**: 音声入力および出力（Realtime API想定）。
  - **Attachments**: 大容量ファイル添付とSSOTハッシュ管理。
  - **History**: 過去の対話履歴の閲覧と、任意ポイントからの再開（Resume）。
  - **Device Support**: PC (Web) / Smartphone (PWA/Native-like).

---

## 3. Remote Bridge (Architecture)
- **Model**: Agent Host (Home PC) <--> Secure Transport <--> Client (Smartphone)
- **Security**:
  - **Network**: 永続的な **NETWORK DENY** ポリシー（許可されたAPIエンドポイントのみ）。
  - **Transport**: VPN または Secure Relay (End-to-End Encryption)。
  - **Auth**: Device登録制 + 短命トークン + mTLS（推奨）。
- **Governance**:
  - **Approval Queue**: 重要操作（課金/破壊/Deploy）は必ず承認キューを経由する。
  - **Evidence**: 全操作ログ（Command/Files）をSSOTへ追記保存（改竄検知）。

---

## 4. Worktree & Command Execution
- **Worktree**: Task IDごとの作業ディレクトリ隔離（並列開発の衝突防止）。
- **Command Runner**:
  - **Wrapped Execution**: 任意シェル（`subprocess.run(shell=True)`）は禁止。
  - **Allowlist**: 事前に許可されたラップ関数（`git_checkout`, `pytest_run` 等）のみ実行可能。
  - **Resource Control**: Timeout設定、メモリ制限、Denylistによる物理ガード。

---

## 5. 開発プロセス (SSOT Cycle)
1. **Spec Update**: 本仕様書 (v2.1) をSSOTとして更新。
2. **Evidence**: 変更理由と整合性を記録。
3. **Preflight**: CIによる自動チェック。
4. **Approve & Merge**: 人間（または権限委譲されたAI）による承認必須。

---

## 6. 旧版との関係
- **v0.2 (Productivity Kit)**: 本仕様書に取り込み済み（Worktree/Auto-Task/Approval）。
- **SSOT v2.0 Patch**: 本仕様書に完全統合。

以上
