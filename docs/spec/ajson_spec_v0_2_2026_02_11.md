# AJSON 設計仕様書 (v0.2)
Version: 0.2
Date: 2026-02-11
Status: Draft

## 0. 結論
本仕様書は、AJSON (Agent-driven JSON Orchestrator) のバージョン0.2における設計仕様を定義する。
v0.1 のMVP機能（状態機械、安全なツール実行、SSOT）を包含しつつ、v0.2にて以下の拡張を行う。
1. **添付ファイル**: 大容量対応とSSOT保管の厳密化。
2. **RPA定義**: API連携を主軸とし、外部サービスRPAを「最後の手段」として再定義。
3. **ローカル操作**: Local Workspace Connectorによる安全なファイル操作の実装（プロトタイプ限定）。
4. **コスト試算**: 開発および運用にかかるコスト構造の明文化。

---

## 1. 用語定義
- **AJSON**: 本システムの名称。エージェント駆動型JSONオーケストレーター。
- **Mission**: ユーザーが達成したいゴール。JSON形式で定義される。
- **Orchestrator**: Missionの状態遷移を管理する中核コンポーネント。
- **Jarvis**: プランニングを担当するAIエージェントロール。
- **Cody**: 監査・監視を担当するAIエージェントロール。
- **Runner**: ツール（コマンド、API等）を実際に実行するコンポーネント。
- **SSOT (Single Source of Truth)**: システムの唯一の真実となるデータストア（SQLite + ファイルシステム）。
- **Allowlist / Denylist**: ツール実行における許可リストと拒否リスト。

---

## 2. プロダクト要件
- **目的**: 信頼性の高い「Office-N」ビジネスロジックによるAIエージェントオーケストレーション。
- **提供形態**:
  - v0.1: MVPプロトタイプ（ローカル動作、DRY_RUN主体）。
  - v0.2: プロトタイプ拡張（ローカルファイル操作、RPA概念実証）。
  - Future: 販売モデルへの展開。
- **コア価値**: 「カオスなAI」を「秩序あるビジネスロジック」で制御する。

---

## 3. 機能要件 (Cockpit)
- **Mission Console**:
  - Web UIによるインタラクティブな操作（`http://localhost:8000/console`）。
  - Missionの作成、進捗確認、承認アクション。
- **添付ファイル (v0.2 追加)**:
  - **容量要件**: 最低保証として 512MB/ファイル、プロジェクト全体で 2.5TB を下限とする。
  - **保管**: アップロードされたファイルはSSOT（`uploads/` 等）に保管し、ハッシュ値で管理する。
  - **再開/分割**: 大容量ファイルに対応するため、再開・分割アップロードを想定した設計とする。

---

## 4. アーキテクチャ
- **Starship Architecture**: システム全体を宇宙船に見立てた階層構造。
  - **Cockpit**: UI層 (FastAPI + Jinja2/Frontend)。
  - **Computer**: Orchestrator (State Machine)。
  - **Engine**: LLM Connector (Mock / OpenAI)。
  - **Cargo**: SSOT (Database + Artifacts)。
- **依存関係**: 上位層は下位層に依存するが、逆は真ではない。

---

## 5. 状態機械
Missionは以下の状態遷移を持つ。
`CREATED` → `PLANNED` → `PRE_AUDIT` → `EXECUTE` → `POST_AUDIT` → `FINALIZE` → `DONE`
   ↓
`PENDING_APPROVAL`: 危険操作や重要アクション（Deploy, Delete等）検出時に遷移し、ユーザー承認を待機する。

---

## 6. エージェント設計
- **Jarvis (Planner)**:
  - 役割: ユーザーリクエストの解釈、Stepへの分解、実行計画の立案。
  - 特性: 創造的だが、ハルシネーションのリスクがあるためCodyの監視下で動作。
- **Cody (Auditor)**:
  - 役割: Jarvisの計画の監査、安全ルールの適用、Allowlist/Denylistチェック。
  - 特性: 保守的。ルールベースでの却下権限を持つ。

---

## 7. コネクタ設計
- **Tool Runner**:
  - 全ての外部操作（CLI, API）はRunner経由で行う。
  - **Manifest**: 各ツールはManifest（定義ファイル）を持ち、入力バリデーションを行う。
  - 直接的なシェル実行は原則禁止とし、ラップされた関数のみを公開する。

---

## 8. RPA設計 (v0.2 改定)
- **定義**: Robotic Process Automation。AJSONにおける自動化の定義を厳密化する。
- **対象外 (Non-Goal)**:
  - 「ChatGPTアプリ版」「Geminiアプリ版」など、**既存AIサービスのWeb UIを自動操作すること**。これらはUI変更に脆弱であり、AJSONの信頼性を損なうため対象外とする。
- **対象内**:
  1. **API連携**: ChatGPT API, Gemini API 等、公式APIを使用した連携（本筋）。
  2. **外部サービスRPA**: APIが存在しない、または機能が不足している場合の「最後の手段」。
- **外部サービスRPAの必須条件**:
  - **Allowlist**: 事前に許可されたドメイン（URL）に対してのみ実行可能。
  - **承認ゲート**: データ送信、購入、削除などの「破壊的・不可逆的」操作には、必ず`PENDING_APPROVAL`による人間承認を要求する。
  - **証跡**: 操作の全過程を記録する（Video, Trace, Screenshot, DOM差分）。
  - **SOS停止**: CAPTCHA、追加認証（2FA）、不審な挙動を検知した場合は即座に停止し、人間に介入を求める。

---

## 9. 音声 (Voice)
- v0.1/v0.2 時点では、音声入力・出力のインターフェースおよびスタブ実装のみとする。
- 将来的にはRealtime API等を用いた対話機能を想定。

---

## 10. SSOT / Evidence / Artifacts
- **SSOT**: `ajson.db` (SQLite) および `workspace/`, `uploads/` ディレクトリ。
- **Evidence**:
  - 全ての`Step`実行結果、`ToolRun`ログはDBに記録される。
  - 添付ファイルはハッシュ化され、改竄検知可能な状態で保存される。
- **Artifacts**: 生成物（コード、文書）は指定された成果物ディレクトリに集約される。

---

## 11. 開発ワークフロー
- **Git Flow**: `main` ブランチを保護し、Featureブランチ + PR で開発を進める。
- **Checks**: CI（Preflight, Lint, Test）による品質ガード。
- **Review**: 原則として `jarvisrv` (AI) または人間による承認を必須とする。

---

## 12. 開発ワークフレーム
- 標準的なPythonプロジェクト構成を採用。
- 型ヒント（Type Hints）、Docstring、単体テストを必須とする。

---

## 13. 連携ツール
- 現時点ではCLIおよびWeb Consoleのみ。
- 将来的にSlack, Discord等のチャットツール連携を拡張可能とする。

---

## 14. コスト (v0.2 追補)
本セクションでは、開発および運用にかかるコストの概算方法を定義する。
※金額は各サービスの価格改定により変動するため、参照URLと計算式を示す。

### 14.3 運用時コスト（固定費 + 変動費）[推定]
- **サーバー費用**:
  - 参照: [AWS EC2 Pricing](https://aws.amazon.com/ec2/pricing/), [Google Cloud Compute Pricing](https://cloud.google.com/compute/pricing)
  - 式: `(インスタンス単価 * 稼働時間) + (ストレージ単価 * 容量)`
  - 例: 汎用インスタンス(2vCPU, 4GB) * 730時間 + EBS 50GB
- **LLM API費用**:
  - 参照: [OpenAI Pricing](https://openai.com/pricing)
  - 式: `(入力トークン数 * 入力単価) + (出力トークン数 * 出力単価)`
  - 例: GPT-4o (1M input / 100k output)
- **その他**: ドメイン代、SSL証明書（Let's Encryptなら無料）

### 14.4 開発時コスト（初期）[推定]
- **人件費**: エンジニア単価 * 工期。
- **開発ツール**:
  - GitHub Copilot, IDE ライセンス等。
  - 参照: [GitHub Pricing](https://github.com/pricing)
  - 式: `(月額ライセンス料 * 人数 * 月数)`

### 14.5 サンプル試算（目安）
※あくまで小規模プロトタイプ運用を想定した一例である。
- **条件**: 月間アクティブユーザー10名、1日あたり100回の高品質LLMインタラクション。
- **LLM**: 約 $10 ~ $30 / 月 （モデル依存）
- **インフラ**: ローカル運用なら $0、クラウド最小構成なら約 $20 / 月
- **合計**: **$30 ~ $50 / 月** （変動あり）

---

## 15. できること / できないこと

### できること
- **ローカルフォルダ操作 (Local Workspace Connector) (v0.2)**:
  - Antigravity機能を模したプロトタイプ限定機能。
  - **対象**: 作業ディレクトリ（`./workspace` 等）配下のみ。
  - **基本操作**: `list`, `read`, `write`, `mkdir`, `move`, `rename`。
  - **追加 (Create)**: 新規ファイル・ディレクトリ作成。
  - **削除 (Delete)**:
    1. **通常削除 (Trash)**: `.trash/` ディレクトリへの移動（復元可能、承認不要）。
    2. **恒久削除 (Permanent)**: システムからの完全削除。**承認キュー (Approval Queue) 経由での承認、および事前のバックアップ/証跡作成を必須**とする。

### できないこと
- **作業ディレクトリ外へのアクセス**: `../` 等を含むパス指定の禁止。
- **権限変更**: `chmod`, `chown` 等の実行禁止。
- **ネットワーク実通信 (現状)**: 外部への無制限なアクセス（NETWORK DENYポリシー）。
- **任意コマンド実行**: Denylistに含まれる危険なコマンド（`rm -rf /` 等）の実行。

---

## 16. セキュリティ / 運用
- **NETWORK永続DENY**:
  - 開発およびテストフェーズにおいて、外部への意図しない通信を物理的・論理的に遮断する。
  - 必要な通信（API等）は明示的に許可されたエンドポイントのみに限定する。
- **ガードレール**:
  - `scripts/` 配下のスクリプトによるPreflightチェック、Commit Hookによる保護。

---

## 17. SSOT更新手順
1. 本仕様書 (`docs/spec/ajson_spec_v0_2_*.md`) を更新。
2. 変更内容をEvidence (`docs/evidence/`) として記録。
3. PRを作成し、Preflightチェックをパスした上でマージする。
